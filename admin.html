<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenTrends Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .tab-button.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .table-container { max-height: 60vh; overflow-y: auto; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">
    -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
    <main class="container mx-auto px-4 py-8">
        <!-- Admin Login Form -->
        <section id="loginForm" class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto my-12">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Admin Login</h2>
            <form id="adminLoginForm">
                <div class="mb-4">
                    <label for="adminEmail" class="block text-gray-700 font-medium mb-2">Email</label>
                    <input type="email" id="adminEmail" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="adminPassword" class="block text-gray-700 font-medium mb-2">Password</label>
                    <input type="password" id="adminPassword" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition-colors duration-200">Log In</button>
            </form>
        </section>

        <!-- Admin Dashboard -->
        <section id="adminDashboard" class="hidden">
            <header class="flex items-center justify-between pb-4 border-b-2 border-gray-200 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">GenTrends Admin Dashboard</h1>
                <button id="logoutBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200">Logout</button>
            </header>

            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="flex border-b border-gray-200">
                    <button id="productsTabBtn" class="tab-button active py-4 px-6 text-gray-600 font-medium focus:outline-none transition-all duration-200">Products</button>
                    <button id="ordersTabBtn" class="tab-button py-4 px-6 text-gray-600 font-medium focus:outline-none transition-all duration-200">Orders</button>
                </div>

                <!-- Products Tab Content -->
                <div id="productsTab" class="mt-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Product Management</h2>
                    <form id="addProductForm" class="bg-gray-50 p-6 rounded-lg mb-6">
                        <input type="hidden" id="productId">
                        <h3 class="text-xl font-medium mb-4 text-gray-800" id="formTitle">Add New Product</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="productName" class="block text-gray-700 font-medium mb-1">Product Name</label>
                                <input type="text" id="productName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="productPrice" class="block text-gray-700 font-medium mb-1">Price</label>
                                <input type="number" id="productPrice" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="productDescription" class="block text-gray-700 font-medium mb-1">Description</label>
                            <textarea id="productDescription" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="imageUrls" class="block text-gray-700 font-medium mb-1">Product Image URL (e.g., from ImgBB)</label>
                            <input type="text" id="imageUrls" placeholder="Paste ImgBB link here..." required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <button type="submit" class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors duration-200" id="submitBtn">Add Product</button>
                        <button type="button" class="bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition-colors duration-200 hidden" id="cancelEditBtn">Cancel Edit</button>
                    </form>

                    <h3 class="text-xl font-medium mb-4 text-gray-800">All Products</h3>
                    <div class="table-container shadow-md rounded-xl overflow-hidden">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Image</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Product Name</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Price</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Stock Status</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Tab Content -->
                <div id="ordersTab" class="mt-6 hidden">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Order Management</h2>
                    <div class="table-container shadow-md rounded-xl overflow-hidden">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Order ID</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Customer</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Ordered Items</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Total Price</th>
                                    <th class="py-3 px-4 text-left font-semibold text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Orders will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Notification/Message Box -->
        <div id="messageBox" class="fixed bottom-8 right-8 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg z-50 transform translate-x-full transition-transform duration-300">
            <span id="messageText"></span>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration and initialization
        const appId = "1:314115877640:web:4cc10bcba4c2d840ff5abd";
        const firebaseConfig = {
            apiKey: "AIzaSyCgwqkl0GUDqJlk16vLRLAFW_pS9TOpI88",
            authDomain: "gentrends-store.firebaseapp.com",
            projectId: "gentrends-store",
            storageBucket: "gentrends-store.firebasestorage.app",
            messagingSenderId: "314115877640",
            appId: "1:314115877640:web:4cc10bcba4c2d840ff5abd"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        
        // UI Elements
        const loginFormSection = document.getElementById('loginForm');
        const adminDashboardSection = document.getElementById('adminDashboard');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const productsTabBtn = document.getElementById('productsTabBtn');
        const ordersTabBtn = document.getElementById('ordersTabBtn');
        const productsTab = document.getElementById('productsTab');
        const ordersTab = document.getElementById('ordersTab');
        const addProductForm = document.getElementById('addProductForm');
        const productsTableBody = document.getElementById('productsTableBody');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        
        let currentEditingProductId = null;
        
        // Function to show a temporary message
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            messageBox.classList.remove('translate-x-full');
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 3000);
        }
        
        // Tab switching logic
        function switchTab(tab) {
            productsTab.classList.add('hidden');
            ordersTab.classList.add('hidden');
            productsTabBtn.classList.remove('active');
            ordersTabBtn.classList.remove('active');
            
            if (tab === 'products') {
                productsTab.classList.remove('hidden');
                productsTabBtn.classList.add('active');
            } else if (tab === 'orders') {
                ordersTab.classList.remove('hidden');
                ordersTabBtn.classList.add('active');
            }
        }
        
        productsTabBtn.addEventListener('click', () => switchTab('products'));
        ordersTabBtn.addEventListener('click', () => switchTab('orders'));

        // Admin login
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Login successful!");
                loginFormSection.classList.add('hidden');
                adminDashboardSection.classList.remove('hidden');
            } catch (error) {
                console.error("Login failed: ", error);
                showMessage('Login failed. Check your credentials.', true);
            }
        });
        
        // Admin logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("Logged out successfully.");
            } catch (error) {
                console.error("Logout failed: ", error);
                showMessage('Logout failed.', true);
            }
        });
        
        // Function to render products table
        function renderProductsTable(products) {
            productsTableBody.innerHTML = '';
            products.forEach(product => {
                const stockStatus = product.stock ? `<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">In Stock</span>` : `<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">Out of Stock</span>`;
                const toggleButtonText = product.stock ? "Mark Out of Stock" : "Mark In Stock";
                const toggleButtonClass = product.stock ? "bg-red-500 hover:bg-red-600" : "bg-green-500 hover:bg-green-600";
                
                const row = document.createElement('tr');
                row.className = 'border-b last:border-b-0 hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-4"><img src="${product.imageUrls[0]}" class="w-16 h-16 rounded-lg object-cover"></td>
                    <td class="py-3 px-4">${product.name}</td>
                    <td class="py-3 px-4">₹${product.price.toFixed(2)}</td>
                    <td class="py-3 px-4">${stockStatus}</td>
                    <td class="py-3 px-4 space-x-2">
                        <button data-id="${product.id}" class="edit-btn bg-yellow-400 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-yellow-500 transition-colors duration-200">Edit</button>
                        <button data-id="${product.id}" class="delete-btn bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors duration-200">Delete</button>
                        <button data-id="${product.id}" data-stock="${product.stock}" class="toggle-stock-btn ${toggleButtonClass} text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">${toggleButtonText}</button>
                    </td>
                `;
                productsTableBody.appendChild(row);
            });
            
            // Add event listeners for buttons
            productsTableBody.querySelectorAll('.edit-btn').forEach(button => button.addEventListener('click', handleEditProduct));
            productsTableBody.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', handleDeleteProduct));
            productsTableBody.querySelectorAll('.toggle-stock-btn').forEach(button => button.addEventListener('click', handleStockUpdate));
        }
        
        // Function to render orders table
        function renderOrdersTable(orders) {
            ordersTableBody.innerHTML = '';
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'border-b last:border-b-0 hover:bg-gray-50 transition-colors duration-150';
                const orderItemsHtml = order.orderItems.map(item => `<li class="text-sm text-gray-600">${item.name} (x${item.quantity})</li>`).join('');
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm">${order.id.substring(0, 8)}...</td>
                    <td class="py-3 px-4">
                        <p class="font-semibold">${order.customerName}</p>
                        <p class="text-xs text-gray-500">${order.email}</p>
                        <p class="text-xs text-gray-500">${order.mobileNumber}</p>
                        <p class="text-xs text-gray-500">Pincode: ${order.pincode}</p>
                        <p class="text-xs text-gray-500">${order.address}</p>
                    </td>
                    <td class="py-3 px-4">
                        <ul class="list-disc list-inside space-y-1">${orderItemsHtml}</ul>
                    </td>
                    <td class="py-3 px-4 font-semibold text-blue-600">₹${order.totalPrice.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <select data-id="${order.id}" class="status-select border border-gray-300 rounded-lg py-1 px-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                    </td>
                `;
                ordersTableBody.appendChild(row);
            });
            
            // Add event listeners for status dropdown
            ordersTableBody.querySelectorAll('.status-select').forEach(select => select.addEventListener('change', handleStatusUpdate));
        }
        
        // Add/Edit Product form submission
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productName = document.getElementById('productName').value;
            const productPrice = parseFloat(document.getElementById('productPrice').value);
            const productDescription = document.getElementById('productDescription').value;
            const imageUrlsFromInput = document.getElementById('imageUrls').value.split(',').map(url => url.trim()).filter(url => url);
            
            if (imageUrlsFromInput.length === 0) {
                showMessage("Please enter at least one image URL.", true);
                return;
            }

            const productData = {
                name: productName,
                price: productPrice,
                description: productDescription,
                imageUrls: imageUrlsFromInput
            };
            
            try {
                if (currentEditingProductId) {
                    const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, currentEditingProductId);
                    await setDoc(productDocRef, productData, { merge: true });
                    showMessage("Product updated successfully!");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/products`), { ...productData, stock: true });
                    showMessage("Product added successfully!");
                }
                resetForm();
            } catch (error) {
                console.error("Error saving product: ", error);
                showMessage("Failed to save product.", true);
            }
        });
        
        function resetForm() {
            addProductForm.reset();
            formTitle.textContent = "Add New Product";
            submitBtn.textContent = "Add Product";
            cancelEditBtn.classList.add('hidden');
            currentEditingProductId = null;
        }

        cancelEditBtn.addEventListener('click', resetForm);
        
        // Edit product functionality
        async function handleEditProduct(e) {
            const productId = e.target.dataset.id;
            const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
            const productSnap = await getDoc(productDocRef);
            
            if (productSnap.exists()) {
                const product = productSnap.data();
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('imageUrls').value = product.imageUrls.join(', ');
                
                formTitle.textContent = "Edit Product";
                submitBtn.textContent = "Update Product";
                cancelEditBtn.classList.remove('hidden');
                currentEditingProductId = productId;
                showMessage(`Editing product: ${product.name}`);
            } else {
                showMessage("Product not found.", true);
            }
        }
        
        // Delete product functionality
        async function handleDeleteProduct(e) {
            const productId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, productId));
                    showMessage("Product deleted successfully!");
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showMessage("Failed to delete product.", true);
                }
            }
        }
        
        // Update stock status functionality
        async function handleStockUpdate(e) {
            const productId = e.target.dataset.id;
            const currentStockStatus = e.target.dataset.stock === 'true';
            const newStockStatus = !currentStockStatus;
            
            try {
                const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, productId);
                await updateDoc(productDocRef, { stock: newStockStatus });
                showMessage(`Product stock status updated to '${newStockStatus ? 'In Stock' : 'Out of Stock'}'`);
            } catch (error) {
                console.error("Error updating stock status: ", error);
                showMessage("Failed to update stock status.", true);
            }
        }
        
        // Update order status functionality
        async function handleStatusUpdate(e) {
            const orderId = e.target.dataset.id;
            const newStatus = e.target.value;
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { status: newStatus });
                showMessage(`Order status updated to '${newStatus}'.`);
            } catch (error) {
                console.error("Error updating order status: ", error);
                showMessage("Failed to update order status.", true);
            }
        }
        
        // Initial setup on page load
        window.onload = async () => {
            try {
                // Initialize Firebase with provided configuration
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate with the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loginFormSection.classList.add('hidden');
                        adminDashboardSection.classList.remove('hidden');
                        
                        // Set up real-time listeners for products and orders
                        const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
                        onSnapshot(productsCollectionRef, (querySnapshot) => {
                            console.log("Admin Panel: Received a new product snapshot.");
                            const products = [];
                            querySnapshot.forEach(doc => {
                                products.push({ id: doc.id, ...doc.data() });
                            });
                            console.log(`Admin Panel: Found ${products.length} products.`);
                            renderProductsTable(products);
                        });
                        
                        const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
                        onSnapshot(ordersCollectionRef, (querySnapshot) => {
                            const orders = [];
                            querySnapshot.forEach(doc => {
                                orders.push({ id: doc.id, ...doc.data() });
                            });
                            renderOrdersTable(orders);
                        });
                    } else {
                        loginFormSection.classList.remove('hidden');
                        adminDashboardSection.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showMessage("Failed to initialize the application.", true);
            }
        };
    </script>
</body>
</html>
