<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenTrends E-commerce</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        /* Mobile-specific adjustments for the modal */
        #productModal > div {
            transform: scale(1);
            max-width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
            #productModal > div {
                transform: scale(0.95);
                max-width: 64rem;
                height: auto;
                margin: 1rem;
                border-radius: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="bg-white shadow-md py-4">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center justify-between">
            <div class="w-full md:w-auto flex items-center justify-between mb-4 md:mb-0">
                <a href="#" class="text-2xl font-bold text-gray-800 rounded-lg p-2 hover:bg-gray-200 transition-colors duration-200">GenTrends</a>
                <button id="cartIcon" class="relative text-gray-600 hover:text-blue-500 transition-colors duration-200 md:hidden">
                    <i class="fas fa-shopping-cart text-2xl"></i>
                    <span id="cartCount" class="absolute -top-2 -right-2 bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>
            <div class="flex-grow w-full md:max-w-lg md:mx-8 relative mb-4 md:mb-0">
                <input type="text" id="searchInput" placeholder="Search for products..." class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <nav class="w-full md:w-auto flex justify-center md:justify-end items-center space-x-6">
                <a href="#home" class="text-gray-600 hover:text-blue-500 transition-colors duration-200 font-medium text-sm md:text-base">Home</a>
                <a href="#products" class="text-gray-600 hover:text-blue-500 transition-colors duration-200 font-medium text-sm md:text-base">Products</a>
                <a href="#status" class="text-gray-600 hover:text-blue-500 transition-colors duration-200 font-medium text-sm md:text-base">Status</a>
                <button id="cartIconDesktop" class="relative text-gray-600 hover:text-blue-500 transition-colors duration-200 hidden md:inline-block">
                    <i class="fas fa-shopping-cart text-2xl"></i>
                    <span id="cartCountDesktop" class="absolute -top-2 -right-2 bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </nav>
        </div>
    </header>

    <main id="mainContent" class="container mx-auto px-4 py-8 flex-grow">
        <section id="home" class="py-8">
            <h1 class="text-4xl md:text-5xl font-bold text-center mb-4 text-gray-800">Welcome to GenTrends</h1>
            <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto text-sm md:text-base">Explore the latest trends in fashion and technology. Find your next favorite item with our curated selection of high-quality products.</p>
        </section>

        <section id="products" class="py-8">
            <h2 class="text-3xl md:text-4xl font-bold mb-6 text-gray-800">Our Products</h2>
            <div id="productGrid" class="product-grid">
                <!-- Product cards will be dynamically inserted here -->
            </div>
        </section>

        <section id="status" class="py-8 hidden">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Check Order Status</h2>
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                <div class="mb-4">
                    <label for="statusInput" class="block text-gray-700 font-medium mb-2">Enter your Email or Mobile Number</label>
                    <input type="text" id="statusInput" placeholder="Email or Mobile" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                </div>
                <button id="checkStatusBtn" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition-colors duration-200">Check Status</button>
            </div>
            <div id="orderStatusDisplay" class="mt-8">
                <!-- Order status results will be displayed here -->
            </div>
        </section>

        <!-- Product Detail Modal -->
        <div id="productModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
            <div class="bg-white rounded-xl shadow-2xl p-4 md:p-8 w-full h-full md:w-auto md:h-auto md:max-w-4xl relative transform scale-95 transition-transform duration-300">
                <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <div class="flex flex-col md:flex-row gap-8 overflow-y-auto">
                    <div id="modalImageGallery" class="flex-1">
                        <!-- Product images will be dynamically loaded here -->
                        <img src="" alt="Product Image" id="modalMainImage" class="w-full h-auto object-cover rounded-lg shadow-lg mb-4">
                    </div>
                    <div class="flex-1">
                        <h3 id="modalProductName" class="text-2xl md:text-3xl font-bold mb-2 text-gray-800"></h3>
                        <p id="modalProductPrice" class="text-xl md:text-2xl font-semibold text-blue-600 mb-4"></p>
                        <p id="modalProductDescription" class="text-gray-600 mb-6 text-sm md:text-base"></p>
                        <button id="addToCartBtn" class="bg-blue-500 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-600 transition-colors duration-200 w-full md:w-auto">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart/Checkout View Modal -->
        <div id="cartModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
            <div class="bg-white rounded-xl shadow-2xl p-4 md:p-8 w-full h-full md:w-auto md:h-auto md:max-w-3xl relative transform scale-95 transition-transform duration-300">
                <button id="closeCartModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl md:text-3xl font-bold mb-6 text-gray-800">Your Cart</h3>
                <div id="cartSummary" class="mb-6 overflow-y-auto max-h-[60vh]">
                    <!-- Cart items will be dynamically loaded here -->
                </div>
                <div id="checkoutForm" class="bg-gray-50 p-6 rounded-lg">
                    <h4 class="text-xl md:text-2xl font-semibold mb-4 text-gray-800">Checkout</h4>
                    <form id="placeOrderForm">
                        <div class="mb-4">
                            <label for="customerName" class="block text-gray-700 font-medium mb-1 text-sm">Full Name</label>
                            <input type="text" id="customerName" name="customerName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="mobileNumber" class="block text-gray-700 font-medium mb-1 text-sm">Mobile Number</label>
                            <input type="tel" id="mobileNumber" name="mobileNumber" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="email" class="block text-gray-700 font-medium mb-1 text-sm">Email</label>
                            <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="mb-4">
                            <label for="shippingAddress" class="block text-gray-700 font-medium mb-1 text-sm">Shipping Address</label>
                            <textarea id="shippingAddress" name="shippingAddress" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                        </div>
                        <div class="mb-6">
                            <h5 class="text-gray-700 font-medium mb-2 text-sm">Payment Method</h5>
                            <label class="inline-flex items-center text-sm">
                                <input type="radio" name="paymentMethod" value="cod" checked class="form-radio text-blue-600">
                                <span class="ml-2">Cash on Delivery (COD)</span>
                            </label>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-sm md:text-base">Place Order</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notification/Message Box -->
        <div id="messageBox" class="fixed bottom-4 md:bottom-8 right-4 md:right-8 bg-green-500 text-white px-4 py-3 md:px-6 md:py-4 rounded-xl shadow-lg z-50 transform translate-x-full transition-transform duration-300">
            <span id="messageText" class="text-sm md:text-base"></span>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-8 rounded-t-xl">
        <div class="container mx-auto text-center">
            <p>&copy; 2024 GenTrends. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration and initialization
        const appId = "1:314115877640:web:4cc10bcba4c2d840ff5abd";
        const firebaseConfig = {
            apiKey: "AIzaSyCgwqkl0GUDqJlk16vLRLAFW_pS9TOpI88",
            authDomain: "gentrends-store.firebaseapp.com",
            projectId: "gentrends-store",
            storageBucket: "gentrends-store.firebasestorage.app",
            messagingSenderId: "314115877640",
            appId: "1:314115877640:web:4cc10bcba4c2d840ff5abd"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let productsData = [];

        // UI Elements
        const mainContent = document.getElementById('mainContent');
        const productGrid = document.getElementById('productGrid');
        const cartIconMobile = document.getElementById('cartIcon');
        const cartIconDesktop = document.getElementById('cartIconDesktop');
        const cartCountMobileSpan = document.getElementById('cartCount');
        const cartCountDesktopSpan = document.getElementById('cartCountDesktop');
        const searchInput = document.getElementById('searchInput');

        // Modals and Forms
        const productModal = document.getElementById('productModal');
        const cartModal = document.getElementById('cartModal');
        const placeOrderForm = document.getElementById('placeOrderForm');
        const statusSection = document.getElementById('status');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const orderStatusDisplay = document.getElementById('orderStatusDisplay');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Navigation
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('section').forEach(section => {
                    section.classList.add('hidden');
                });
                const sectionId = e.target.getAttribute('href').substring(1);
                if (sectionId) {
                    document.getElementById(sectionId).classList.remove('hidden');
                }
            });
        });

        cartIconMobile.addEventListener('click', () => {
            renderCartSummary();
            cartModal.classList.remove('hidden');
        });
        
        cartIconDesktop.addEventListener('click', () => {
            renderCartSummary();
            cartModal.classList.remove('hidden');
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            productModal.classList.add('hidden');
        });

        document.getElementById('closeCartModalBtn').addEventListener('click', () => {
            cartModal.classList.add('hidden');
        });

        // Function to show a temporary message
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            messageBox.classList.remove('translate-x-full');
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 3000);
        }
        
        // Function to update the cart count in the header
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            cartCountMobileSpan.textContent = totalItems;
            cartCountDesktopSpan.textContent = totalItems;
        }
        
        // Function to render product cards on the page
        function renderProducts(products) {
            productGrid.innerHTML = '';
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden cursor-pointer';
                productCard.innerHTML = `
                    <img src="${product.imageUrls[0]}" alt="${product.name}" class="w-full h-64 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">${product.name}</h3>
                        <p class="text-blue-600 font-bold">$${product.price.toFixed(2)}</p>
                    </div>
                `;
                productCard.addEventListener('click', () => showProductDetail(product));
                productGrid.appendChild(productCard);
            });
        }
        
        // Function to show product detail modal
        function showProductDetail(product) {
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductPrice').textContent = `$${product.price.toFixed(2)}`;
            document.getElementById('modalProductDescription').textContent = product.description;
            document.getElementById('modalMainImage').src = product.imageUrls[0];
            
            const addToCartBtn = document.getElementById('addToCartBtn');
            addToCartBtn.onclick = () => addToCart(product);
            
            productModal.classList.remove('hidden');
        }

        // Add product to local storage cart
        function addToCart(product) {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            if (cart[product.id]) {
                cart[product.id].quantity += 1;
            } else {
                cart[product.id] = { ...product, quantity: 1 };
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            showMessage(`${product.name} added to cart!`);
        }
        
        // Render the cart summary in the modal
        function renderCartSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            const cartSummaryDiv = document.getElementById('cartSummary');
            let total = 0;
            cartSummaryDiv.innerHTML = '';
            
            if (Object.keys(cart).length === 0) {
                cartSummaryDiv.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`;
                placeOrderForm.classList.add('hidden');
                return;
            }

            placeOrderForm.classList.remove('hidden');
            
            Object.values(cart).forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const cartItem = document.createElement('div');
                cartItem.className = 'flex items-center justify-between py-2 border-b last:border-b-0';
                cartItem.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">$${item.price.toFixed(2)} x ${item.quantity}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-800">$${itemTotal.toFixed(2)}</span>
                        <button class="remove-item-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${item.id}">&times;</button>
                    </div>
                `;
                cartSummaryDiv.appendChild(cartItem);
            });
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToRemove = e.target.dataset.id;
                    const updatedCart = JSON.parse(localStorage.getItem('cart'));
                    delete updatedCart[idToRemove];
                    localStorage.setItem('cart', JSON.stringify(updatedCart));
                    renderCartSummary();
                    updateCartCount();
                });
            });

            // Add total
            const totalDiv = document.createElement('div');
            totalDiv.className = 'flex justify-between items-center mt-4 pt-4 border-t-2 border-dashed';
            totalDiv.innerHTML = `<span class="text-lg font-bold">Total:</span><span class="text-xl font-bold text-blue-600">$${total.toFixed(2)}</span>`;
            cartSummaryDiv.appendChild(totalDiv);
        }
        
        // Handle checkout form submission
        placeOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cart = JSON.parse(localStorage.getItem('cart'));
            if (!cart || Object.keys(cart).length === 0) {
                showMessage('Your cart is empty. Please add items to place an order.', true);
                return;
            }
            
            const formData = new FormData(placeOrderForm);
            const orderDetails = {
                customerName: formData.get('customerName'),
                mobileNumber: formData.get('mobileNumber'),
                email: formData.get('email'),
                address: formData.get('shippingAddress'),
                orderItems: Object.values(cart).map(item => ({ id: item.id, name: item.name, quantity: item.quantity, price: item.price })),
                totalPrice: Object.values(cart).reduce((sum, item) => sum + item.price * item.quantity, 0),
                status: 'Pending',
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), orderDetails);
                localStorage.removeItem('cart');
                updateCartCount();
                cartModal.classList.add('hidden');
                showMessage('Order placed successfully! Thank you for your purchase.');
                placeOrderForm.reset();
            } catch (error) {
                console.error("Error placing order: ", error);
                showMessage('Failed to place order. Please try again.', true);
            }
        });
        
        // Handle order status check
        checkStatusBtn.addEventListener('click', async () => {
            const input = document.getElementById('statusInput').value.trim();
            if (!input) {
                showMessage('Please enter an email or mobile number.', true);
                return;
            }
            
            orderStatusDisplay.innerHTML = '<p class="text-center text-gray-500">Checking for orders...</p>';
            
            try {
                let orders = [];
                // Query by email
                const emailQuery = query(collection(db, `artifacts/${appId}/public/data/orders`), where('email', '==', input));
                const emailSnapshot = await getDocs(emailQuery);
                emailSnapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                // Query by mobile number
                const mobileQuery = query(collection(db, `artifacts/${appId}/public/data/orders`), where('mobileNumber', '==', input));
                const mobileSnapshot = await getDocs(mobileQuery);
                mobileSnapshot.forEach(doc => {
                    // Avoid duplicates if both email and mobile match the same document
                    if (!orders.some(order => order.id === doc.id)) {
                        orders.push({ id: doc.id, ...doc.data() });
                    }
                });

                if (orders.length > 0) {
                    orderStatusDisplay.innerHTML = `<h3 class="text-xl font-bold mb-4">Orders Found:</h3>`;
                    orders.forEach(order => {
                        const orderItem = document.createElement('div');
                        orderItem.className = 'bg-white p-6 rounded-xl shadow-lg mb-4';
                        orderItem.innerHTML = `
                            <p class="font-bold">Order ID: <span class="text-gray-600 font-normal">${order.id}</span></p>
                            <p class="font-bold">Status: <span class="text-blue-500 font-normal">${order.status}</span></p>
                            <p class="font-bold">Order Date: <span class="text-gray-600 font-normal">${order.createdAt.toDate().toLocaleString()}</span></p>
                            <p class="font-bold mt-2">Items:</p>
                            <ul class="list-disc list-inside text-gray-600">
                                ${order.orderItems.map(item => `<li>${item.name} (${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}</li>`).join('')}
                            </ul>
                            <p class="font-bold mt-2">Total: <span class="text-blue-600">$${order.totalPrice.toFixed(2)}</span></p>
                        `;
                        orderStatusDisplay.appendChild(orderItem);
                    });
                } else {
                    orderStatusDisplay.innerHTML = `<p class="text-center text-gray-500">No orders found for that email or mobile number.</p>`;
                }
            } catch (error) {
                console.error("Error fetching order status: ", error);
                orderStatusDisplay.innerHTML = `<p class="text-center text-red-500">An error occurred. Please try again later.</p>`;
            }
        });

        // Search functionality
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredProducts = productsData.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.description.toLowerCase().includes(searchTerm)
            );
            renderProducts(filteredProducts);
        });

        // Initial setup on page load
        window.onload = async () => {
            try {
                // Initialize Firebase with provided configuration
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate with the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Check for auth state changes before proceeding with Firestore operations
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Authenticated with user:", user.uid);
                        // Fetch products once the user is authenticated
                        const productsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
                        const q = query(productsCollectionRef);
                        onSnapshot(q, (querySnapshot) => {
                            productsData = [];
                            querySnapshot.forEach((doc) => {
                                productsData.push({ id: doc.id, ...doc.data() });
                            });
                            renderProducts(productsData);
                        });
                        updateCartCount();
                    } else {
                        console.log("Authentication failed.");
                        showMessage("Authentication failed. Please check the provided token.", true);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showMessage("Failed to initialize the application.", true);
            }
        };
    </script>
</body>
</html>
